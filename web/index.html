<html>
<head>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script defer>
		var sources = {
			floors: 'floors',
			cryogenic2: 'cryogenic2'
		};

		function loadAssets(sources, callback) {
			var assetDir = 'sprites/';
			var imageExtension = '.dmi';
			var metaExtension = '.meta';
			var images = {};
			var loadedAssets = 0;
			var numAssets = Object.keys(sources).length * 2;

			loaded_callback = function() {
				if(++loadedAssets >= numAssets) {
					callback(images);
				}
			};

			for(var src in sources) {
				images[src] = new Image();
				images[src].onload = loaded_callback;
				images[src].src = assetDir + sources[src] + imageExtension;
				$.get(  assetDir + sources[src] + metaExtension, function( data ) {
					images[src].meta = parse_meta( data );
					loaded_callback();
				});
			}
		}

		function parse_meta( dmi_meta ) {
			var reKeyVal = /(.+) = (.+)/g
			var meta = {};
			var states = {};
			var curState = "";
			var lastState = "";
			var curFrameOffset = 0;

			while ((kv = reKeyVal.exec(dmi_meta)) !== null) {
				var key = kv[1], val = kv[2];
				if ( key == "version" ) {
					if ( val != "4.0" ) throw "Cannot decode DMI version" + val
				}
				else if ( key == "state" ) {
					lastState = curState;
					curState = val.replace(/(^")|("$)/g, '');
					if (lastState != "" ) {
						var dirs = states[lastState]["dirs"]  || 0;
						var frames = states[lastState]["frames"] || 0;
						curFrameOffset += Math.max( 1, dirs, frames );
					}
					states[curState] = { frameOffset: curFrameOffset };
				}
				else {
					var prop = /\s+(.*)/.exec(key)[1];
					if (states[curState])
						states[curState][prop] = val;
					else
						meta[prop] = val;
				}
			}
			meta["states"] = states;
			return meta;
		}


		loadAssets(sources, function(images) {
			console.log("done");
		});

</script>
</head>
<body>
</body>
</html>
