<html>
<head>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="assets.js"></script>
	<script defer>

		var canvas_width = 15, canvas_height = 15; // in tiles
		var clock = 597; //arbitrarily chosen

		var basic_floor = {
			bank: "floors",
			state: "floor"
		};

		var cryo_top = {
			bank: "cryogenic2",
			state: "celltop_1",
			start: clock,
		};

		var cryo_bottom = {
			bank: "cryogenic2",
			state: "cellbottom",
			start: clock,
		};

		var world_data = {}; //TODO: update from a websocket
		for ( x = 0; x <  canvas_width; x++ ) {
			for ( y = 0; y < canvas_height; y++ ) {
				world_data[ x + ',' + y] = [basic_floor];
			}
		}

		world_data['4,4'].push(cryo_top);
		world_data['4,5'].push(cryo_bottom);


		frameBuffer = document.createElement("canvas");
		frameBuffer.width = 32 * canvas_width;
		frameBuffer.height = 32 * canvas_height;

		world_pos = { x: 7, y: 7 };
		function update_framebuffer() {
			var delta_x = (canvas_width - 1) / 2,
			delta_y = (canvas_height - 1) / 2;  

			for ( x = world_pos.x - delta_x; x < world_pos.x + delta_x; x++ ) {
				for ( y = world_pos.y - delta_y; y < world_pos.x + delta_y; y++ ) {
					var tile = world_data[ x + ',' + y];
					var abs_x = x - world_pos.x + delta_x,
					abs_y = y - world_pos.y + delta_y;
					tile.forEach( function(sprite) {
						draw_sprite_fb( sprite.bank, sprite.state, abs_x, abs_y, sprite.start );
					})
				}
			}
		}


		//functions
		var draw_sprite_fb, update_canvas;

		loadAssets(sources, function(images) {
			var canvas = document.getElementById( "main_canvas" );
			canvas.width = frameBuffer.width;
			canvas.height = frameBuffer.height;
			var ctx = canvas.getContext("2d");
			draw_sprite_fb = function( bank_name, state, x, y, start ) {
				draw_sprite( bank_name, state, x, y, start, clock, images, frameBuffer.getContext("2d") );
			}
			update_canvas = function() {
				ctx.drawImage( frameBuffer, 0, 0 );
			}

			console.log("Assets loaded.");
			setInterval( function() {
				clock++;
				update_framebuffer();
				update_canvas();
			}, 250)
		});


	</script>
</head>
<body>
	<canvas id="main_canvas"></canvas>
</body>
</html>
