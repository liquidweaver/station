<html>
<head>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script defer>
		var sources = {
			floors: 'floors',
			cryogenic2: 'cryogenic2'
		};
		var canvas_width = 8, canvas_height = 8; // in tiles

		frameBuffer = document.createElement("canvas");
		frameBuffer.width = 32 * canvas_width;
		frameBuffer.height = 32 * canvas_height;

		function loadAssets(sources, callback) {
			var assetDir = 'sprites/';
			var imageExtension = '.dmi';
			var metaExtension = '.meta';
			var images = {};
			var loadedAssets = 0;
			var numAssets = Object.keys(sources).length * 2;

			loaded_callback = function() {
				if(++loadedAssets >= numAssets) {
					callback(images);
				}
			};

			for(var src in sources) {
				images[src] = new Image();
				images[src].onload = loaded_callback;
				images[src].src = assetDir + sources[src] + imageExtension;
				(function(bank){
					$.get(  assetDir + sources[src] + metaExtension, function( data ) {
						images[bank].meta = parse_meta( data );
						loaded_callback();
					});
				})(src);
			}
		}

		function parse_meta( dmi_meta ) {
			var reKeyVal = /(.+) = (.+)/g
			var meta = {};
			var states = {};
			var curState = "";
			var lastState = "";
			var curFrameOffset = 0;

			while ((kv = reKeyVal.exec(dmi_meta)) !== null) {
				var key = kv[1], val = kv[2];
				if ( key == "version" ) {
					if ( val != "4.0" ) throw "Cannot decode DMI version" + val
				}
				else if ( key == "state" ) {
					lastState = curState;
					curState = val.replace(/(^")|("$)/g, '');
					if (lastState != "" ) {
						var dirs = states[lastState]["dirs"]  || 0;
						var frames = states[lastState]["frames"] || 0;
						curFrameOffset += Math.max( 1, dirs, frames );
					}
					states[curState] = { frameOffset: curFrameOffset };
				}
				else {
					var prop = /\s+(.*)/.exec(key)[1];
					if (states[curState])
						states[curState][prop] = val;
					else
						meta[prop] = val;
				}
			}
			meta["states"] = states;
			return meta;
		}

		function draw_sprite( bank_name, state, x, y, images, dest_ctx ) {
			var width = images[bank_name].meta.width,
					height = images[bank_name].meta.height;

			var framesWide = images[bank_name].width / width;
			var frameOffset = images[bank_name].meta.states[state].frameOffset;
			var sx = (frameOffset % framesWide) * width,
					sy = Math.floor(frameOffset / framesWide) * height;
			var px = x * 32, py = y * 32;

			dest_ctx.drawImage( images[bank_name], sx, sy, width, height, px, py, width, height );
		}

		//functions
		var draw_sprite_fb, update_canvas;


		loadAssets(sources, function(images) {
			var canvas = document.getElementById( "main_canvas" );
			var ctx = canvas.getContext("2d");
			draw_sprite_fb = function( bank_name, state, x, y ) {
				draw_sprite( bank_name, state, x, y, images, frameBuffer.getContext("2d") );
			}
			update_canvas = function() {
				ctx.drawImage( frameBuffer, 0, 0 );
			}
			for ( x  = 0; x < 4; x++ ) {
				for ( y  = 0; y < 4; y++ ) {
					draw_sprite_fb( "floors", "floor", x, y );
				}
			}
			draw_sprite_fb( "cryogenic2", "body_scanner_0", 1, 1);
			draw_sprite_fb( "cryogenic2", "body_scanner_0-r", 1, 2);
			update_canvas();
			console.log("done");
		});

</script>
</head>
<body>
	<canvas id="main_canvas"></canvas>
</body>
</html>
