var sources = {
  "160x160":"160x160",
  "1x2blast_hor":"1x2blast_hor",
  "1x2blast_vert":"1x2blast_vert",
  "1x4blast_hor":"1x4blast_hor",
  "1x4blast_vert":"1x4blast_vert",
  "224x224":"224x224",
  "288x288":"288x288",
  "480x480":"480x480",
  "96x96":"96x96",
  "AI":"AI",
  "Door1":"Door1",
  "Door2x1glass":"Door2x1glass",
  "DoorHazard":"DoorHazard",
  "DoorHazard2x1":"DoorHazard2x1",
  "Dooratmo":"Dooratmo",
  "Dooratmoglass":"Dooratmoglass",
  "Doorbananium":"Doorbananium",
  "Doorcom":"Doorcom",
  "Doorcomglass":"Doorcomglass",
  "Doordiamond":"Doordiamond",
  "Doorele":"Doorele",
  "Dooreng":"Dooreng",
  "Doorengglass":"Doorengglass",
  "Doorext":"Doorext",
  "Doorf":"Doorf",
  "Doorfire":"Doorfire",
  "Doorfreezer":"Doorfreezer",
  "Doorglass":"Doorglass",
  "Doorgold":"Doorgold",
  "Doorhatchele":"Doorhatchele",
  "Doorhatchmaint2":"Doorhatchmaint2",
  "Doormaint":"Doormaint",
  "Doormining":"Doormining",
  "Doorminingglass":"Doorminingglass",
  "Doorplasma":"Doorplasma",
  "Doorsand":"Doorsand",
  "Doorsec":"Doorsec",
  "Doorsecglass":"Doorsecglass",
  "Doorsilver":"Doorsilver",
  "Dooruranium":"Dooruranium",
  "Targeted":"Targeted",
  "ULIcons":"ULIcons",
  "Zone":"Zone",
  "aibots":"aibots",
  "air_meter":"air_meter",
  "airlock_machines":"airlock_machines",
  "alert":"alert",
  "alien":"alien",
  "alienqueen":"alienqueen",
  "alphacolors":"alphacolors",
  "am_engine":"am_engine",
  "ammo":"ammo",
  "amorph":"amorph",
  "animal":"animal",
  "antimatter":"antimatter",
  "apc_repair":"apc_repair",
  "apiary_bees_etc":"apiary_bees_etc",
  "areas":"areas",
  "artifacts":"artifacts",
  "artillery":"artillery",
  "ashtray":"ashtray",
  "assemblies":"assemblies",
  "atmos":"atmos",
  "atmos_testing":"atmos_testing",
  "ausflora":"ausflora",
  "autopsy_scanner":"autopsy_scanner",
  "back":"back",
  "barsigns":"barsigns",
  "basketball":"basketball",
  "beach":"beach",
  "beach2":"beach2",
  "beam":"beam",
  "belt":"belt",
  "belt_mirror":"belt_mirror",
  "belts":"belts",
  "biogenerator":"biogenerator",
  "biomass":"biomass",
  "blob":"blob",
  "blood":"blood",
  "bloodpack":"bloodpack",
  "blue_pipe_tank":"blue_pipe_tank",
  "bodybag":"bodybag",
  "buildmode":"buildmode",
  "bureaucracy":"bureaucracy",
  "cameravis":"cameravis",
  "candle":"candle",
  "card":"card",
  "chemical":"chemical",
  "chempuff":"chempuff",
  "chemsmoke":"chemsmoke",
  "christmas":"christmas",
  "cigarettes":"cigarettes",
  "cloning":"cloning",
  "closet":"closet",
  "coatrack":"coatrack",
  "cold_sink":"cold_sink",
  "collar":"collar",
  "computer":"computer",
  "contamination":"contamination",
  "contraband":"contraband",
  "corgi_back":"corgi_back",
  "corgi_head":"corgi_head",
  "crayondecal":"crayondecal",
  "crayons":"crayons",
  "critter":"critter",
  "cryobag":"cryobag",
  "cryogenic2":"cryogenic2",
  "cryogenics":"cryogenics",
  "cult":"cult",
  "custom-synthetic":"custom-synthetic",
  "custom_items":"custom_items",
  "dam_human":"dam_human",
  "dam_mask":"dam_mask",
  "deadtrees":"deadtrees",
  "debug_connect":"debug_connect",
  "debug_group":"debug_group",
  "debug_rebuild":"debug_rebuild",
  "debug_space":"debug_space",
  "decal_warning_stripes":"decal_warning_stripes",
  "decals":"decals",
  "device":"device",
  "dice":"dice",
  "digital_valve":"digital_valve",
  "disposal":"disposal",
  "door_assembly":"door_assembly",
  "door_assembly2x1":"door_assembly2x1",
  "door_fire2":"door_fire2",
  "doorint":"doorint",
  "doormed":"doormed",
  "doormedglass":"doormedglass",
  "doormorgue":"doormorgue",
  "doorresearch":"doorresearch",
  "doorresearchglass":"doorresearchglass",
  "doorsci":"doorsci",
  "doorsciglass":"doorsciglass",
  "dp_vent_pump":"dp_vent_pump",
  "drinks":"drinks",
  "drip":"drip",
  "dropper":"dropper",
  "ears":"ears",
  "edge_Doorfire":"edge_Doorfire",
  "effects":"effects",
  "engine":"engine",
  "eyes":"eyes",
  "feet":"feet",
  "fiber":"fiber",
  "field_generator":"field_generator",
  "filter":"filter",
  "fire":"fire",
  "flamethrower":"flamethrower",
  "floodlight":"floodlight",
  "floors":"floors",
  "fluidtracks":"fluidtracks",
  "food":"food",
  "food_ingredients":"food_ingredients",
  "footprints":"footprints",
  "fullscreen":"fullscreen",
  "fullscreen_halloween":"fullscreen_halloween",
  "fullscreen_original":"fullscreen_original",
  "gateway":"gateway",
  "genetics":"genetics",
  "gimmick_head":"gimmick_head",
  "glasses":"glasses",
  "gloves":"gloves",
  "grenade":"grenade",
  "gun":"gun",
  "guncabinet":"guncabinet",
  "hacktool":"hacktool",
  "hands":"hands",
  "harvest":"harvest",
  "hats":"hats",
  "head":"head",
  "heat":"heat",
  "heat_exchanger":"heat_exchanger",
  "heavy_fiber":"heavy_fiber",
  "heavy_lathe":"heavy_lathe",
  "hightechsecurity":"hightechsecurity",
  "hivebot":"hivebot",
  "holosign":"holosign",
  "hud":"hud",
  "human":"human",
  "human_face":"human_face",
  "hydroponics":"hydroponics",
  "imap":"imap",
  "implantchair":"implantchair",
  "inpipe":"inpipe",
  "items":"items",
  "items_lefthand":"items_lefthand",
  "items_righthand":"items_righthand",
  "iv_drip":"iv_drip",
  "janitor":"janitor",
  "junction":"junction",
  "kitchen":"kitchen",
  "large":"large",
  "largeui":"largeui",
  "lasers":"lasers",
  "library":"library",
  "lighting":"lighting",
  "limb_mask":"limb_mask",
  "liquid":"liquid",
  "livestock":"livestock",
  "lockwall":"lockwall",
  "magic":"magic",
  "magic_terror":"magic_terror",
  "mainframe":"mainframe",
  "mainspipe":"mainspipe",
  "mark":"mark",
  "mask":"mask",
  "masks":"masks",
  "mech_bay":"mech_bay",
  "mech_construct":"mech_construct",
  "mech_construction":"mech_construction",
  "mech_fab":"mech_fab",
  "mecha":"mecha",
  "mecha_equipment":"mecha_equipment",
  "mecha_mouse":"mecha_mouse",
  "mediwall":"mediwall",
  "meteor":"meteor",
  "meter":"meter",
  "mineral_doors":"mineral_doors",
  "minimap":"minimap",
  "mining":"mining",
  "mining_machines":"mining_machines",
  "mixer":"mixer",
  "mob":"mob",
  "module":"module",
  "monitors":"monitors",
  "monkey":"monkey",
  "musician":"musician",
  "n2o_pipe_tank":"n2o_pipe_tank",
  "nanopaste":"nanopaste",
  "narsie":"narsie",
  "new_assemblies":"new_assemblies",
  "nvg_hud_full":"nvg_hud_full",
  "objects":"objects",
  "orange_pipe_tank":"orange_pipe_tank",
  "outlet_injector":"outlet_injector",
  "overlays":"overlays",
  "oxygen_generator":"oxygen_generator",
  "paper":"paper",
  "particle_accelerator":"particle_accelerator",
  "particle_accelerator2":"particle_accelerator2",
  "passive_gate":"passive_gate",
  "pda":"pda",
  "pinetrees":"pinetrees",
  "pipe-item":"pipe-item",
  "pipe_manifold":"pipe_manifold",
  "pipe_tank":"pipe_tank",
  "pipe_vent":"pipe_vent",
  "pipes":"pipes",
  "pipes2":"pipes2",
  "plants":"plants",
  "plasma":"plasma",
  "podwindows":"podwindows",
  "policetape":"policetape",
  "portables_connector":"portables_connector",
  "power":"power",
  "power_cond_heavy":"power_cond_heavy",
  "power_cond_white":"power_cond_white",
  "power_local":"power_local",
  "projectiles":"projectiles",
  "pump":"pump",
  "r_def_human":"r_def_human",
  "r_def_lizard":"r_def_lizard",
  "r_def_plant":"r_def_plant",
  "r_def_skrell":"r_def_skrell",
  "r_def_tajaran":"r_def_tajaran",
  "r_def_vox":"r_def_vox",
  "r_diona":"r_diona",
  "r_human":"r_human",
  "r_lizard":"r_lizard",
  "r_machine":"r_machine",
  "r_plant":"r_plant",
  "r_skeleton":"r_skeleton",
  "r_skrell":"r_skrell",
  "r_tajaran":"r_tajaran",
  "r_vox":"r_vox",
  "radar":"radar",
  "radio":"radio",
  "rapid_pdoor":"rapid_pdoor",
  "reagentfillings":"reagentfillings",
  "recycling":"recycling",
  "red_orange_pipe_tank":"red_orange_pipe_tank",
  "red_pipe":"red_pipe",
  "red_pipe_tank":"red_pipe_tank",
  "regular":"regular",
  "relief_valve":"relief_valve",
  "research":"research",
  "robot_component":"robot_component",
  "robot_parts":"robot_parts",
  "robotic":"robotic",
  "robotics":"robotics",
  "robots":"robots",
  "rocks":"rocks",
  "rollerbed":"rollerbed",
  "rune":"rune",
  "screen1":"screen1",
  "screen1_Midnight":"screen1_Midnight",
  "screen1_Orange":"screen1_Orange",
  "screen1_White":"screen1_White",
  "screen1_action":"screen1_action",
  "screen1_alien":"screen1_alien",
  "screen1_full":"screen1_full",
  "screen1_old":"screen1_old",
  "screen1_robot":"screen1_robot",
  "seeds":"seeds",
  "shards":"shards",
  "shoes":"shoes",
  "shuttle":"shuttle",
  "singularity":"singularity",
  "slimes":"slimes",
  "smoothlattice":"smoothlattice",
  "snow":"snow",
  "snowflora":"snowflora",
  "space":"space",
  "spacevines":"spacevines",
  "species":"species",
  "ss13_dark_alpha7":"ss13_dark_alpha7",
  "ss13_dark_alpha7_DEBUG":"ss13_dark_alpha7_DEBUG",
  "ss13_dark_alpha7_old":"ss13_dark_alpha7_old",
  "static":"static",
  "station_explosion":"station_explosion",
  "stationobjs":"stationobjs",
  "status_display":"status_display",
  "stock_parts":"stock_parts",
  "storage":"storage",
  "structures":"structures",
  "suit":"suit",
  "suits":"suits",
  "suitstorage":"suitstorage",
  "surgery":"surgery",
  "syndieweapons":"syndieweapons",
  "syringe":"syringe",
  "syringefilling":"syringefilling",
  "talk":"talk",
  "tank":"tank",
  "tatt1":"tatt1",
  "telescience":"telescience",
  "terminals":"terminals",
  "ties":"ties",
  "tile_effects":"tile_effects",
  "tomatodecal":"tomatodecal",
  "toy":"toy",
  "transit_tube":"transit_tube",
  "transit_tube_pod":"transit_tube_pod",
  "transit_tube_station":"transit_tube_station",
  "trash":"trash",
  "tubing":"tubing",
  "turf_analysis":"turf_analysis",
  "turrets":"turrets",
  "uniform":"uniform",
  "uniform_fat":"uniform_fat",
  "uniforms":"uniforms",
  "uristrunes":"uristrunes",
  "valve":"valve",
  "vault":"vault",
  "vehicles":"vehicles",
  "vending":"vending",
  "vent_pump":"vent_pump",
  "vent_scrubber":"vent_scrubber",
  "vialbox":"vialbox",
  "virology":"virology",
  "volume_pump":"volume_pump",
  "vox":"vox",
  "walllocker":"walllocker",
  "wallrot":"wallrot",
  "walls":"walls",
  "walls48":"walls48",
  "warning_stripes":"warning_stripes",
  "washing_machine":"washing_machine",
  "water":"water",
  "watercloset":"watercloset",
  "weapons":"weapons",
  "windoor":"windoor",
  "wizard":"wizard",
  "xenoarchaeology":"xenoarchaeology",
  "zone_sel":"zone_sel",
};



function loadAssets(sources, callback) {
  var assetDir = 'sprites/';
  var imageExtension = '.dmi';
  var metaExtension = '.meta';
  var image_banks = {};
  var loadedAssets = 0;
  var numAssets = Object.keys(sources).length * 2;

  loaded_callback = function() {
    if(++loadedAssets >= numAssets) {
      callback(image_banks);
    }
  };

  for(var src in sources) {
    image_banks[src] = new Image();
    image_banks[src].onload = loaded_callback;
    image_banks[src].src = assetDir + sources[src] + imageExtension;
    (function(bank){
      $.get(  assetDir + sources[src] + metaExtension, function( data ) {
        image_banks[bank].meta = parse_raw_dmi_meta( data );
        loaded_callback();
      });
    })(src);
  }
}

function clock_frame_map( delay_array ) {
  var clock_frames = [];
  var offset = 0, curFrameNum = 0;

  delay_array.forEach( function(lengthstr) {
    var length = Number(lengthstr);
    for ( x = offset; x < offset + length; x++ ) {
      clock_frames[x] = curFrameNum;
    }
    offset += length;
    curFrameNum++;
  });

  return clock_frames;
}

function parse_raw_dmi_meta( raw_dmi_meta ) {
  var reKeyVal = /(.+) = (.+)/g
  var meta = {};
  var states = {};
  var curState = undefined;
  var curFrameOffset = 0;

  while ((kv = reKeyVal.exec(raw_dmi_meta)) !== null) {
    var key = kv[1], val = kv[2];
    if ( key == "version" ) {
      if ( val != "4.0" ) throw "Cannot decode DMI version" + val
    }
    else if ( key == "state" ) {    // We are defining a new state
      if ( typeof curState != "undefined" ) {
        var dirs = states[curState]["dirs"]  || 1;
        var frames = states[curState]["frames"] || 1;
        curFrameOffset += dirs * frames;
      }
      curState = val.replace(/(^")|("$)/g, '');

      states[curState] = { frameOffset: curFrameOffset };
    }
    else {                          // Set a property of this state
      var prop = /\s+(.*)/.exec(key)[1];
      if (states[curState])
        states[curState][prop] = val;
        if ( prop == "delay")
          states[curState]["clock_frames"] = clock_frame_map( val.split(',') );
      else                          //Set a global property for this image_bank
        meta[prop] = val;

    }
  }
  meta["states"] = states;
  return meta;
}

function draw_sprite( sprite, x, y, clock, image_banks, dest_ctx ) {
  var image_bank = image_banks[sprite.bank];
  var width = image_bank.meta.width,
  height = image_bank.meta.height;


  var framesWide = image_bank.width / width;
  var state_meta = image_bank.meta.states[sprite.state];
  var frameOffset = state_meta.frameOffset;
  if ( state_meta.clock_frames && sprite.start ) {
      var animOffset = state_meta.clock_frames[ (clock - sprite.start) % state_meta.clock_frames.length ];
      frameOffset += animOffset;
  }
  var sx = (frameOffset % framesWide) * width,
      sy = Math.floor(frameOffset / framesWide) * height;
  var px = x * 32, py = y * 32;

  dest_ctx.drawImage( image_bank, sx, sy, width, height, px, py, width, height );
}





